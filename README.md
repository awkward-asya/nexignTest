# repp

## Задание

### Формулировка
Написать модуль, генерирующий записи звонков в формате CDR (Call Data Record), и создающий отчеты UDR (Usage Data Report) в соответствии со стандартом BCE (Billing and Charging Evolution). Модуль должен включать в себя два сервиса:

1. Сервис генерации CDR файлов, эмулирующий работу коммутатора, который случайным образом генерирует записи звонков абонентов за тарифицируемый период в течение года. Данные о звонках должны сохраняться в текстовые файлы по каждому месяцу, и также должны быть сохранены в локальной базе данных H2.
    
2. Сервис генерации UDR отчетов на основе собранных данных из CDR файлов. Данные должны агрегироваться по абонентам и суммироваться для каждого абонента в отчете по месяцам. Отчеты должны сохраняться в формате JSON в директории /reports.

### Запуск
Приложение можно запустить в терминале, предварительно перейдя в папку с jar-файлом `out/artifacts/nexignTest_jar`

Возможно три варианта вызова. 
1. По умолчанию (без аргументов) выводится отчет по всем абонентам за весь год
![ссылка_на_изображение](https://github.com/awkward-asya/nexignTest/blob/master/images/Снимок%20экрана%202024-03-24%20в%2020.47.56.png)

3. При указании номера абонента первым аргументом будет выведен отчет за год по этому абоненту

4. При указании номера абонента и номера месяца первым и вторым аргументами будет выведен отчет за этот месяц по этому абоненту




### Общий подход к реализации

**Инструменты:**
```
• OpenJDK 17
• Maven
• Jackson
• H2 Database
• JUnit5
• Mockito
```
Вся функциональная часть модуля находится в `src/main/java/nexign/task/`

Модуль разделен на три основные части: 
1. взаимодействие с базой (установка соединения и инициализация номерами абонентов при необходимости, находится в `database`) 
2. сервисы (CDR-сервис и UDR-сервис, находятся в `services`) 
3. вспомогательные функции, используемые другими классами, но не относящиеся к их функциям напрямую которые (находятся в `utilities`). 

По условию задания предполагается, что данные по абонентам уже хранятся в базе, поэтому первая часть была создана скорее для тестирования. Данные для подключения к базе хранятся в `src/main/resources/database.properties`. В рамках реализации предполагается, что абоненты хранятся в таблице с названием `subscribers`.

Старалась выделять отдельные действия в отдельные вспомогательные функции для того чтобы код был яснее.

## Подзадачи 
### Задача 1
#### Формулировка
Необходимо написать сервис, эмулирующий работу коммутатора, для генерации CDR файлов. Сервис должен:
1. Создавать CDR файлы для каждого месяца в течение тарифицируемого периода (1 год).
2. Генерировать записи звонков для случайного количества абонентов из заранее определенного списка (хранящегося в локальной базе данных H2). Задавать случайные длительности и типы звонков (исходящие/входящие).
4. Сохранять данные о звонках пользователей в отдельной таблице той же локальной базы.
#### Реализация
За работу сервиса отвечает класс `GeneratorCDR`. В функции `generateCDRs` каждого месяца функцией `generateMonthCDR` генерируются CDR-записи. При генерации новой записи о звонке проверяется, не пересекается ли она с какими-то еще, потому что в один момент времени абонент может совершать только один звонок. 

Для записей использовала `record`, поскольку нам нужно только записывать данные по звонкам в базу и в файл. Переопределила `compareTo` для обеспечения хронологического порядка.

Предполгается, что максимальная длительность одного звонка - час, а всего звонков за месяц может быть от 20 до 1000.

### Задача 2
#### Формулировка
Необходимо написать сервис генерации UDR отчетов на основе данных из CDR файлов, переданных от сервиса генерации CDR. Сервис должен:
1. Агрегировать данные по каждому абоненту в отчет.
2. Сохранять сгенерированные отчеты в формате JSON в директории `/reports`.
3. Предоставлять возможность генерации отчетов по всем абонентам (метод `generateReport()`), генерировать отчеты за весь период по заданному абоненту (метод `generateReport(msisdn)`), генерировать отчет за определнный месяц по заданному абоненту (метод `generateReport(msisdn, month)`) 
4. Выводить таблицы на основе информации из сгенерированных отчетов в консоль.

#### Реализация
Класс `GeneratorUDR` отвечает за генерацию UDR отчетов на основе данных из CDR файлов. Он обрабатывает CDR файлы для извлечения информации о звонках и создает UDR отчеты по каждому абоненту. Для хранения деталей звонков используется класс `RecordUDR`, который содержит информацию о входящих и исходящих звонках для конкретного абонента. Внутри него определен еще один класс `CallDetails`, созданный для того чтобы удобно изменять информацию по длительности звонков и вывода этой информации в формате строки.

Внутри каждой из перегрузок `generateReport` в каждый рассматриваемый месяц вызывается функция `processCDRFile` которая совершает основные действия по генерации UDR отчета за месяц. Она построчно проверяет CDR файлы за каждый месяц и если необходимо изменяет данные в объекте UDR отчета по каждому абоненту. После обработки файла, если вызвана перегрузка без аргументов (т.е. для всех номеров) она добавляет пустые записи для тех абонентов, которые есть существуют, но не встретились в этом CDR-файле.

После генерации всех отчетов сводные таблицы выводятся в консоль с помощью `printReport` (использующей внутри себя `printReportRow` для вывода отчета за месяц)
